within {{project_name}}.Loads.{{model_name}};
model CouplingETS_TimeSeriesBuilding
  "FMU Template for time series thermal loads building"
extends Modelica.Icons.Example;

  package MediumW = Buildings.Media.Water
    "Source side medium";
  package MediumA = Buildings.Media.Air
    "Load side medium";
{% raw %}
  parameter Modelica.SIunits.MassFlowRate m1_flow_nominal=8
    "Nominal mass flow rate of primary (district) district cooling side";
  parameter Modelica.SIunits.MassFlowRate m2_flow_nominal=bui.terUniCoo.mChiWat_flow_nominal
    "Nominal mass flow rate of secondary (building) district cooling side";

  CoolingIndirect coo(
    redeclare package Medium = MediumW,
    m1_flow_nominal=m1_flow_nominal,
    m2_flow_nominal=m2_flow_nominal,
    dp1_nominal=500,
    dp2_nominal=500,
    dpValve_nominal=7000,
    use_Q_flow_nominal=true,
    Q_flow_nominal=-1*(bui.QCoo_flow_nominal),
    T_a1_nominal=273.15 + 12,
    T_a2_nominal=273.15 + 19)
      annotation (Placement(transformation(extent={{-4,-60},{16,-40}})));
  building bui(
    have_pum=false,
    filPat=
    "modelica://Buildings/Applications/DHC/Loads/Examples/Resources/SwissResidential_20190916.mos",
    mLoaHea_flow_nominal=10,
    mLoaCoo_flow_nominal=30,
    nPorts_a=2,
    nPorts_b=2)
    "Building model integrating time series loads."
      annotation (Placement(transformation(extent={{-6,60},{14,80}})));
  Buildings.Fluid.Sources.Boundary_pT supChiWat(
    redeclare package Medium = MediumW,
    p=330000,
    use_T_in=false,
    T=285.15,
    nPorts=1)
    "Chilled water supply"
      annotation (Placement(transformation(
            extent={{-10,-10},{10,10}},
            rotation=0,
            origin={-30,-10})));
  Buildings.Fluid.Sources.Boundary_pT sinChiWat(
    redeclare package Medium = MediumW,
    p=300000,
    nPorts=1)
     "Sink for chilled water"
      annotation (Placement(transformation(
            extent={{10,-10},{-10,10}},
            rotation=0,
            origin={70,-10})));
  Modelica.Blocks.Sources.RealExpression TChiWatSet(y=14 + 273.15)
    "Primary loop chilled water setpoint temperature"
    annotation (Placement(transformation(extent={{-80,-40},{-60,-20}})));

  Modelica.Blocks.Sources.RealExpression THeaWatSup(y=max(bui.terUniHea.T_aHeaWat_nominal))
    "Heating water supply temperature"
    annotation (Placement(transformation(extent={{-80,20},{-60,40}})));
  Buildings.Fluid.Sources.MassFlowSource_T supHeaWat(
    redeclare package Medium = MediumW,
    m_flow=bui.terUniHea.mHeaWat_flow_nominal,
    use_T_in=true,
    nPorts=1) "Heating water supply"
    annotation (Placement(transformation(
        extent={{-10,-10},{10,10}},
        rotation=0,
        origin={-30,30})));
  Buildings.Fluid.Sources.Boundary_pT sinHeaWat(
    redeclare package Medium =MediumW,
    nPorts=1)
   "Sink for heating water"
     annotation (Placement(transformation(
          extent={{10,-10},{-10,10}},
          rotation=0,
          origin={70,30})));
   Fluid.Movers.FlowControlled_m_flow pumBui(
    redeclare package Medium = MediumW,
    energyDynamics=Modelica.Fluid.Types.Dynamics.FixedInitial,
    m_flow_nominal=bui.terUniCoo.mChiWat_flow_nominal,
    inputType=Buildings.Fluid.Types.InputType.Continuous,
    nominalValuesDefineDefaultPressureCurve=true,
    use_inputFilter=false,
    dp_nominal(displayUnit="bar") = 150000)
    "Building-side (secondary) pump"
    annotation (Placement(transformation(extent={{-40,-80},{-60,-60}})));
  Modelica.Fluid.Sources.FixedBoundary pre(
   redeclare package Medium = MediumW,
    p=300000,
    use_T=false,
   nPorts=1)
    "Pressure source"
   annotation (Placement(transformation(
        extent={{10,-10},{-10,10}},
        rotation=0,
        origin={70,-70})));
  Buildings.Fluid.Sensors.TemperatureTwoPort senTBuiRet(
    redeclare final package Medium = MediumW,
    final m_flow_nominal=bui.terUniCoo.mChiWat_flow_nominal)
    annotation (Placement(transformation(extent={{50,-50},{30,-30}})));
  Buildings.Fluid.Sensors.TemperatureTwoPort senTBuiSup(
    redeclare final package Medium = MediumW,
    final m_flow_nominal=bui.terUniCoo.mChiWat_flow_nominal)
    annotation (Placement(transformation(extent={{-74,60},{-54,80}})));
  Buildings.Fluid.Sensors.TemperatureTwoPort disRet(
    redeclare final package Medium = MediumW,
    final m_flow_nominal=m1_flow_nominal)
    annotation (Placement(transformation(extent={{30,-20},{50,0}})));
  Modelica.Blocks.Sources.RealExpression masFloRat(y=bui.disFloCoo.mReqTot_flow)
  "Primary loop chilled water setpoint temperature"
  annotation (Placement(transformation(extent={{-80,-50},{-60,-30}})));
{% endraw %}
equation
{% raw %}
connect(supChiWat.ports[1], coo.port_a1) annotation (Line(points={{-20,-10},{-4,
         -10},{-4,-44}},color={0,127,255}));
 connect(coo.TSet, TChiWatSet.y) annotation (Line(points={{-6,-50},{-54,-50},{-54,
         -30},{-59,-30}},     color={0,0,127}));
 connect(supHeaWat.ports[1], bui.ports_a[1]) annotation (Line(points={{-20,30},
         {-20,63.3333},{-6,63.3333}}, color={0,127,255}));
 connect(sinHeaWat.ports[1], bui.ports_b[1]) annotation (Line(points={{60,30},{
         26,30},{26,63.3333},{14,63.3333}},color={0,127,255}));
 connect(pre.ports[1], coo.port_b2)  annotation (Line(points={{60,-70},{-4,-70},
         {-4,-56}}, color={0,127,255}));
 connect(senTBuiRet.port_b, coo.port_a2) annotation (Line(points={{30,-40},{26,
         -40},{26,-56},{16,-56}}, color={0,127,255}));
 connect(bui.ports_b[2], senTBuiRet.port_a) annotation (Line(points={{14,64.6667},
         {86,64.6667},{86,-40},{50,-40}}, color={0,127,255}));
 connect(senTBuiSup.port_b, bui.ports_a[2]) annotation (Line(points={{-54,70},{
         -20,70},{-20,64.6667},{-6,64.6667}}, color={0,127,255}));
 connect(senTBuiSup.port_a, pumBui.port_b) annotation (Line(points={{-74,70},{-88,
         70},{-88,-70},{-60,-70}}, color={0,127,255}));
 connect(disRet.port_a, coo.port_b1) annotation (Line(points={{30,-10},{20,-10},
         {20,-44},{16,-44}}, color={0,127,255}));
 connect(pumBui.port_a, coo.port_b2) annotation (Line(points={{-40,-70},{-4,-70},
         {-4,-56}}, color={0,127,255}));
 connect(supHeaWat.T_in, THeaWatSup.y) annotation (Line(points={{-42,34},{-52,34},
         {-52,30},{-59,30}}, color={0,0,127}));
 connect(disRet.port_b, sinChiWat.ports[1]) annotation (Line(points={{50,-10},
        {60,-10}}, color={0,127,255}));
 connect(masFloRat.y, pumBui.m_flow_in)
  annotation (Line(points={{-59,-40},{-50,-40},{-50,-58}}, color={0,0,127}));
{% endraw %}
{% raw %}
annotation (Icon(coordinateSystem(preserveAspectRatio=false),
                           extent={{-100,-100},{100,100}}),
            Diagram(coordinateSystem(preserveAspectRatio=false),
                           extent={{-100,-100},{100,100}}),
 __Dymola_Commands(file="modelica://Buildings/Resources/Scripts/Dymola/Applications/DHC/Loads/Examples/CouplingETS_TimeSeriesBuilding.mos"
        "Simulate and plot"),
        experiment(Tolerance=1e-6,
                   StopTime=131534200),
Documentation(info=
"<html>
<p>
This example illustrates the coupling between the indirect cooling ETS and time series building model.
</p>
</html>",
revisions=
"<html>
<ul>
<li>
April 20, 2020, by Nicholas Long:<br/>
First implementation.
</li>
</ul>
</html>"));
{% endraw %}
end CouplingETS_TimeSeriesBuilding;
